name: Security

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    - cron: "17 4 * * 1"

permissions:
  contents: read
  security-events: write

jobs:
  dependency-audit:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install pip-audit
        run: python -m pip install --upgrade pip pip-audit

      - name: Audit Python dependencies (non-blocking)
        continue-on-error: true
        run: |
          pip-audit -r requirements-dev.txt || true
          pip-audit -r services/api/requirements.txt || true
          pip-audit -r services/worker/requirements.txt || true
          pip-audit -r services/ai_engine/requirements.txt || true

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Setup pnpm (corepack)
        run: |
          corepack enable
          corepack prepare pnpm@9.0.0 --activate
          pnpm --version

      - name: Install Node dependencies
        continue-on-error: true
        run: pnpm install --no-frozen-lockfile

      - name: Audit Node dependencies (non-blocking)
        continue-on-error: true
        run: pnpm audit --audit-level=high || true

  codeql:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Initialize CodeQL
        continue-on-error: true
        uses: github/codeql-action/init@v3
        with:
          languages: javascript, python

      - name: Autobuild
        continue-on-error: true
        uses: github/codeql-action/autobuild@v3

      - name: Analyze
        continue-on-error: true
        uses: github/codeql-action/analyze@v3
